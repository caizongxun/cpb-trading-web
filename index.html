<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>CPB Trading - V5 é æ¸¬ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --accent-color: #2196F3;
            --success-color: #4CAF50;
            --error-color: #f44336;
        }

        body.dark-mode {
            --bg-primary: #1e1e1e;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #404040;
            --accent-color: #64B5F6;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .navbar {
            background-color: var(--accent-color);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .navbar-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .navbar-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .menu-toggle, .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 1rem;
        }

        .menu-toggle:hover, .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .sidebar {
            position: fixed;
            left: -250px;
            top: 60px;
            width: 250px;
            height: calc(100vh - 60px);
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            transition: left 0.3s;
            z-index: 99;
            overflow-y: auto;
            padding-top: 1rem;
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.3s;
            color: var(--text-primary);
        }

        .sidebar-item:hover {
            background-color: var(--border-color);
            border-left-color: var(--accent-color);
        }

        .sidebar-item.active {
            background-color: var(--accent-color);
            color: white;
            border-left-color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .tag-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tag {
            padding: 0.5rem 1rem;
            background-color: var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .tag.active {
            background-color: var(--accent-color);
            color: white;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-card {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }

        .result-card-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .result-card-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            word-break: break-all;
        }

        .result-card-value.positive {
            color: var(--success-color);
        }

        .result-card-value.negative {
            color: var(--error-color);
        }

        .recommendation {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .recommendation.buy {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
        }

        .recommendation.sell {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }

        .recommendation.hold {
            background-color: rgba(255, 193, 7, 0.2);
            color: #FFC107;
        }

        .kline-forecast {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            min-height: 300px;
        }

        .kline-forecast-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .kline-forecast-chart {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            height: 250px;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .kline-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 40px;
            flex: 1;
        }

        .kline-bar {
            width: 100%;
            background: linear-gradient(to top, var(--accent-color), rgba(33, 150, 243, 0.3));
            border-radius: 2px 2px 0 0;
            min-height: 20px;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .kline-bar:hover {
            background: linear-gradient(to top, #1976D2, rgba(25, 118, 210, 0.5));
        }

        .kline-bar.positive {
            background: linear-gradient(to top, var(--success-color), rgba(76, 175, 80, 0.3));
        }

        .kline-bar.positive:hover {
            background: linear-gradient(to top, #388E3C, rgba(56, 142, 60, 0.5));
        }

        .kline-bar.negative {
            background: linear-gradient(to top, var(--error-color), rgba(244, 67, 54, 0.3));
        }

        .kline-bar.negative:hover {
            background: linear-gradient(to top, #D32F2F, rgba(211, 47, 47, 0.5));
        }

        .kline-label {
            font-size: 0.7rem;
            margin-top: 0.5rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .kline-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-primary);
            color: var(--bg-primary);
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            display: none;
            z-index: 10;
        }

        .kline-bar:hover .kline-tooltip {
            display: block;
        }

        .kline-bar.best-entry {
            border: 3px solid #FFD700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .alert-success {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .trend-indicator {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1.1rem;
            margin: 0.5rem 0;
        }

        .trend-indicator.uptrend {
            background-color: rgba(76, 175, 80, 0.2);
            color: var(--success-color);
        }

        .trend-indicator.downtrend {
            background-color: rgba(244, 67, 54, 0.2);
            color: var(--error-color);
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .analysis-item {
            background-color: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .analysis-item.highlight {
            border-color: #FFD700;
            background-color: rgba(255, 215, 0, 0.05);
        }

        .analysis-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .analysis-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0.5rem 0;
        }

        .analysis-value.best {
            color: #FFD700;
            font-size: 2rem;
        }

        .analysis-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="navbar-title">ğŸ“Š CPB Trading V5</div>
        <div class="navbar-controls">
            <button class="menu-toggle" onclick="toggleSidebar()">â˜° èœå–®</button>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ æ·±è‰²</button>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-item active" onclick="switchPage('prediction')">ğŸ“Š é æ¸¬</div>
        <div class="sidebar-item" onclick="switchPage('analysis')">ğŸ“ˆ å¸‚å ´åˆ†æ</div>
        <div class="sidebar-item" onclick="switchPage('settings')">âš™ï¸ è¨­å®š</div>
    </div>

    <div class="container">
        <div id="prediction" class="page active">
            <div class="card">
                <div class="card-title">åŠ å¯†è²¨å¹£åƒ¹æ ¼é æ¸¬</div>

                <div class="form-group">
                    <div class="form-label">ğŸ“Š æ•¸æ“šæºé¸æ“‡</div>
                    <div class="tag-group">
                        <div class="tag active" onclick="setDataSource('yfinance', this)">ğŸ“Š yfinance</div>
                        <div class="tag" onclick="setDataSource('binance', this)">ğŸ”— Binance</div>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                        <span id="source-info">ä½¿ç”¨ yfinanceï¼ˆæ¨è–¦ï¼Œç¢ºä¿ 1D/1H åƒ¹æ ¼ä¸€è‡´ï¼‰</span>
                    </p>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¹£ç¨®</label>
                        <select id="symbol" class="form-control">
                            <option value="BTC">ğŸª™ BTC - æ¯”ç‰¹å¹£</option>
                            <option value="ETH">ğŸª™ ETH - ä»¥å¤ªåŠ</option>
                            <option value="BNB">ğŸª™ BNB - å¹£å®‰å¹£</option>
                            <option value="SOL">ğŸª™ SOL - ç´¢æ‹‰ç´</option>
                            <option value="XRP">ğŸª™ XRP - ç‘æ³¢å¹£</option>
                            <option value="ADA">ğŸª™ ADA - å¡çˆ¾é”è«¾</option>
                            <option value="DOGE">ğŸª™ DOGE - ç‹—ç‹—å¹£</option>
                            <option value="AVAX">ğŸª™ AVAX - é›ªå´©å¹£</option>
                            <option value="LTC">ğŸª™ LTC - èŠç‰¹å¹£</option>
                            <option value="DOT">ğŸª™ DOT - æ³¢å¡</option>
                            <option value="UNI">ğŸª™ UNI - Uniswap</option>
                            <option value="LINK">ğŸª™ LINK - Chainlink</option>
                            <option value="XLM">ğŸª™ XLM - Stellar</option>
                            <option value="ATOM">ğŸª™ ATOM - Cosmos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ™‚é–“æ¡†æ¶</label>
                        <select id="timeframe" class="form-control">
                            <option value="1d">ğŸ“… æ—¥ç·š (1D)</option>
                            <option value="1h">â° å°æ™‚ç·š (1H)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="getPrediction()">ğŸš€ ç²å–é æ¸¬</button>
                <div id="loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æå¸‚å ´æ•¸æ“š...</p>
                </div>
            </div>

            <div id="results" style="display: none;">
                <div id="alert-container"></div>

                <div class="result-grid">
                    <div class="result-card">
                        <div class="result-card-label">ç•¶å‰åƒ¹æ ¼</div>
                        <div class="result-card-value" id="current-price">$0.00</div>
                    </div>
                    <div class="result-card">
                        <div class="result-card-label">é æ¸¬åƒ¹æ ¼</div>
                        <div class="result-card-value" id="predicted-price">$0.00</div>
                    </div>
                    <div class="result-card">
                        <div class="result-card-label">é æœŸæ¼²è·Œ (%)</div>
                        <div class="result-card-value" id="log-return">0.00%</div>
                    </div>
                    <div class="result-card">
                        <div class="result-card-label">ä¿¡å¿ƒåº¦</div>
                        <div class="result-card-value" id="confidence">0.00%</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ’¼ äº¤æ˜“å»ºè­°</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div class="form-label">æ¨è–¦ä¿¡è™Ÿ</div>
                            <div id="recommendation" class="recommendation buy">BUY</div>
                        </div>
                        <div>
                            <div class="form-label">å…¥å ´åƒ¹æ ¼</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);">$<span id="entry-price">0.00</span></div>
                        </div>
                        <div>
                            <div class="form-label">æ­¢æ</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--error-color);">$<span id="stop-loss">0.00</span></div>
                        </div>
                        <div>
                            <div class="form-label">æ­¢ç›ˆ</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--success-color);">$<span id="take-profit">0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“Š å¸‚å ´æ³¢å‹•ç‡</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div class="form-label">ç•¶å‰æ³¢å‹•ç‡</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);"><span id="volatility-current">0.00</span>%</div>
                        </div>
                        <div>
                            <div class="form-label">é æ¸¬æ³¢å‹•ç‡</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);"><span id="volatility-predicted">0.00</span>%</div>
                        </div>
                        <div>
                            <div class="form-label">æ³¢å‹•ç­‰ç´š</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);"><span id="volatility-level">ä¸­</span></div>
                        </div>
                        <div>
                            <div class="form-label">ATR (14)</div>
                            <div style="font-size: 1.2rem; font-weight: bold; color: var(--accent-color);">$<span id="atr-14">0.00</span></div>
                        </div>
                    </div>
                </div>

                <div class="kline-forecast">
                    <div class="kline-forecast-title">ğŸ“ˆ æœªä¾†10æ ¹Kæ£’åƒ¹æ ¼é æ¸¬</div>
                    <div class="kline-forecast-chart" id="forecast-chart"></div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“‹ æœ€è¿‘20æ ¹Kç·š</div>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                            <thead>
                                <tr style="background-color: var(--bg-primary); border-bottom: 2px solid var(--border-color);">
                                    <th style="padding: 0.5rem; text-align: left; color: var(--text-secondary);">æ™‚é–“</th>
                                    <th style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">é–‹ç›¤</th>
                                    <th style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">é«˜</th>
                                    <th style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">ä½</th>
                                    <th style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">æ”¶ç›¤</th>
                                    <th style="padding: 0.5rem; text-align: right; color: var(--text-secondary);">æˆäº¤é‡</th>
                                </tr>
                            </thead>
                            <tbody id="klines-table"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">ğŸ“ é æ¸¬ä¿¡æ¯</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div class="form-label">æ•¸æ“šæº</div>
                            <div style="font-weight: bold; color: var(--text-primary);"><span id="info-source">-</span></div>
                        </div>
                        <div>
                            <div class="form-label">æ¨¡å‹ç‰ˆæœ¬</div>
                            <div style="font-weight: bold; color: var(--text-primary);"><span id="info-model">-</span></div>
                        </div>
                        <div>
                            <div class="form-label">æŸ¥è©¢æ™‚é–“</div>
                            <div style="font-weight: bold; color: var(--text-primary);"><span id="info-time">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analysis" class="page">
            <div class="card">
                <div class="card-title">ğŸ“ˆ å¸‚å ´åˆ†æ - æœ€ä½³é–‹å–®é»ä½</div>

                <div class="form-group">
                    <div class="form-label">ğŸ“Š æ•¸æ“šæºé¸æ“‡</div>
                    <div class="tag-group">
                        <div class="tag active" onclick="setAnalysisDataSource('yfinance', this)">ğŸ“Š yfinance</div>
                        <div class="tag" onclick="setAnalysisDataSource('binance', this)">ğŸ”— Binance</div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">å¹£ç¨®</label>
                        <select id="analysis-symbol" class="form-control">
                            <option value="BTC">ğŸª™ BTC - æ¯”ç‰¹å¹£</option>
                            <option value="ETH">ğŸª™ ETH - ä»¥å¤ªåŠ</option>
                            <option value="BNB">ğŸª™ BNB - å¹£å®‰å¹£</option>
                            <option value="SOL">ğŸª™ SOL - ç´¢æ‹‰ç´</option>
                            <option value="XRP">ğŸª™ XRP - ç‘æ³¢å¹£</option>
                            <option value="ADA">ğŸª™ ADA - å¡çˆ¾é”è«¾</option>
                            <option value="DOGE">ğŸª™ DOGE - ç‹—ç‹—å¹£</option>
                            <option value="AVAX">ğŸª™ AVAX - é›ªå´©å¹£</option>
                            <option value="LTC">ğŸª™ LTC - èŠç‰¹å¹£</option>
                            <option value="DOT">ğŸª™ DOT - æ³¢å¡</option>
                            <option value="UNI">ğŸª™ UNI - Uniswap</option>
                            <option value="LINK">ğŸª™ LINK - Chainlink</option>
                            <option value="XLM">ğŸª™ XLM - Stellar</option>
                            <option value="ATOM">ğŸª™ ATOM - Cosmos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ™‚é–“æ¡†æ¶</label>
                        <select id="analysis-timeframe" class="form-control">
                            <option value="1d">ğŸ“… æ—¥ç·š (1D)</option>
                            <option value="1h">â° å°æ™‚ç·š (1H)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="performMarketAnalysis()">ğŸ” åŸ·è¡Œåˆ†æ</button>
                <div id="analysis-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æå¸‚å ´è¶¨å‹¢èˆ‡æœ€ä½³å…¥å ´é»...</p>
                </div>
            </div>

            <div id="analysis-results" style="display: none;">
                <div id="analysis-alert-container"></div>

                <div class="card">
                    <div class="card-title">è¶¨å‹¢åˆ¤æ–·</div>
                    <div class="analysis-grid">
                        <div class="analysis-item">
                            <div class="analysis-label">ç•¶å‰è¶¨å‹¢</div>
                            <div id="trend-direction" class="trend-indicator uptrend">å¤šé ­</div>
                            <div class="analysis-desc" id="trend-desc">ä¸Šå‡è¶¨å‹¢æ˜é¡¯</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">è¶¨å‹¢å¼·åº¦</div>
                            <div class="analysis-value" id="trend-strength">75%</div>
                            <div class="analysis-desc">ç›¸ç•¶å¼·å‹¢</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">é€£çºŒä¸Šæ¼²æ ¹æ•¸</div>
                            <div class="analysis-value" id="consecutive-up">5æ ¹</div>
                            <div class="analysis-desc">æœ€è¿‘Kç·šè¡¨ç¾</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">å¹³å‡æ¼²å¹…</div>
                            <div class="analysis-value positive" id="avg-return">+2.35%</div>
                            <div class="analysis-desc">æ¯æ ¹æ¼²å¹…</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">æœªä¾†10æ ¹Kæ£’åˆ†æ</div>
                    <div class="kline-forecast">
                        <div class="kline-forecast-title">é æ¸¬èµ°å‹¢èˆ‡æœ€ä½³å…¥å ´é»</div>
                        <div class="kline-forecast-chart" id="analysis-forecast-chart"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">æœ€ä½³é–‹å–®é»ä½</div>
                    <div class="analysis-grid">
                        <div class="analysis-item highlight">
                            <div class="analysis-label">æœ€å„ªå…¥å ´é»</div>
                            <div class="analysis-value best" id="best-entry">+3</div>
                            <div class="analysis-desc">ç¬¬3æ ¹Kæ£’æ™‚å…¥å ´</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">æœ€ä½é»ä½</div>
                            <div class="analysis-value" id="lowest-price">$42,500</div>
                            <div class="analysis-desc" id="lowest-bar">ç¬¬5æ ¹Kæ£’å‡ºç¾</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">ç›®æ¨™é«˜é»</div>
                            <div class="analysis-value positive" id="highest-price">$44,800</div>
                            <div class="analysis-desc" id="highest-bar">ç¬¬9æ ¹Kæ£’å‡ºç¾</div>
                        </div>
                        <div class="analysis-item">
                            <div class="analysis-label">æ½›åœ¨æ”¶ç›Š</div>
                            <div class="analysis-value positive" id="potential-profit">+5.4%</div>
                            <div class="analysis-desc">å¾æœ€ä½åˆ°æœ€é«˜é»</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">è©³ç´°å»ºè­°</div>
                    <div style="background-color: var(--bg-primary); padding: 1rem; border-radius: 6px; border-left: 4px solid var(--accent-color);">
                        <p id="analysis-recommendation" style="color: var(--text-primary); line-height: 1.6; margin: 0;">
                            æ ¹æ“šè¶¨å‹¢åˆ†æï¼Œç›®å‰è™•æ–¼å¼·å‹¢å¤šé ­...
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="settings" class="page">
            <div class="card">
                <div class="card-title">âš™ï¸ æ‡‰ç”¨è¨­å®š</div>
                <div class="form-group">
                    <label class="form-label">ä¸»é¡Œè¨­å®š</label>
                    <div class="tag-group">
                        <div class="tag" onclick="setTheme('light')">â˜€ï¸ äº®è‰²æ¨¡å¼</div>
                        <div class="tag" onclick="setTheme('dark')">ğŸŒ™ æ·±è‰²æ¨¡å¼</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">API ç«¯é»</label>
                    <input type="text" class="form-control" id="api-endpoint" value="http://localhost:8001" />
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ ä¿å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = localStorage.getItem('api_endpoint') || 'http://localhost:8001';
        let currentDataSource = localStorage.getItem('dataSource') || 'yfinance';
        let currentAnalysisDataSource = localStorage.getItem('analysisDataSource') || 'yfinance';

        // æ™ºèƒ½å°æ•¸ä½æ•¸æ ¼å¼åŒ–å‡½æ•¸
        function formatPrice(price) {
            if (!price || price === 0) return '0.00';
            
            const priceStr = price.toString();
            
            if (price < 0.0001) {
                const match = priceStr.match(/^0\.(0+)/);
                if (match) {
                    const zeros = match[1].length;
                    return price.toFixed(zeros + 4).replace(/0+$/, '');
                }
            }
            
            if (price >= 1) {
                const decimal = priceStr.split('.')[1];
                if (!decimal) return price.toFixed(2);
                
                let validDecimals = decimal.replace(/0+$/, '');
                if (validDecimals.length === 0) return Math.floor(price).toString();
                
                validDecimals = validDecimals.substring(0, 10);
                return price.toString().split('.')[0] + '.' + validDecimals;
            }
            
            const decimal = priceStr.split('.')[1];
            if (!decimal) return '0.00';
            
            let validDecimals = decimal.replace(/0+$/, '');
            validDecimals = validDecimals.substring(0, 10);
            
            return '0.' + validDecimals;
        }

        // åˆå§‹åŒ–
        function init() {
            const theme = localStorage.getItem('theme') || 'light';
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            }
            document.getElementById('api-endpoint').value = API_BASE;
        }

        // åˆ‡æ›é é¢
        function switchPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            document.getElementById(pageName).classList.add('active');
            event.target.classList.add('active');
            closeSidebar();
        }

        // åˆ‡æ›å´é‚Šæ¬„
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
        }

        // åˆ‡æ›æ·±è‰²æ¨¡å¼
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('theme', theme);
        }

        // æ•¸æ“šæºé¸æ“‡
        function setDataSource(source, element) {
            currentDataSource = source;
            localStorage.setItem('dataSource', source);
            
            document.querySelectorAll('.tag-group')[0].querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            const infoMap = {
                'yfinance': 'ä½¿ç”¨ yfinanceï¼ˆæ¨è–¦ï¼Œç¢ºä¿ 1D/1H åƒ¹æ ¼ä¸€è‡´ï¼‰',
                'binance': 'ä½¿ç”¨ Binance APIï¼ˆå¯¦æ™‚æ€§æ›´å¥½ï¼‰'
            };
            document.getElementById('source-info').textContent = infoMap[source];
        }

        // å¸‚å ´åˆ†ææ•¸æ“šæºé¸æ“‡
        function setAnalysisDataSource(source, element) {
            currentAnalysisDataSource = source;
            localStorage.setItem('analysisDataSource', source);
            
            const groups = document.querySelectorAll('.tag-group');
            if (groups[1]) {
                groups[1].querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                element.classList.add('active');
            }
        }

        // ç²å–é æ¸¬
        async function getPrediction() {
            const symbol = document.getElementById('symbol').value;
            const timeframe = document.getElementById('timeframe').value;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('alert-container').innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/predict-v5`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        use_binance: currentDataSource === 'binance'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayResults(data);
                } else {
                    showAlert('error', data.detail || 'ç²å–é æ¸¬å¤±æ•—');
                }
            } catch (error) {
                showAlert('error', 'é€£æ¥éŒ¯èª¤ï¼š' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // åŸ·è¡Œå¸‚å ´åˆ†æ
        async function performMarketAnalysis() {
            const symbol = document.getElementById('analysis-symbol').value;
            const timeframe = document.getElementById('analysis-timeframe').value;
            
            document.getElementById('analysis-loading').style.display = 'block';
            document.getElementById('analysis-results').style.display = 'none';
            document.getElementById('analysis-alert-container').innerHTML = '';

            try {
                const response = await fetch(`${API_BASE}/market-analysis`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        timeframe: timeframe,
                        use_binance: currentAnalysisDataSource === 'binance'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    displayAnalysisResults(data);
                } else {
                    showAnalysisAlert('error', data.detail || 'å¸‚å ´åˆ†æå¤±æ•—');
                }
            } catch (error) {
                showAnalysisAlert('error', 'é€£æ¥éŒ¯èª¤ï¼š' + error.message);
            } finally {
                document.getElementById('analysis-loading').style.display = 'none';
            }
        }

        // é¡¯ç¤ºåˆ†æçµæœ
        function displayAnalysisResults(data) {
            // è¶¨å‹¢åˆ¤æ–·
            const trendElement = document.getElementById('trend-direction');
            const trendClass = data.trend.direction === 'uptrend' ? 'uptrend' : 'downtrend';
            const trendText = data.trend.direction === 'uptrend' ? 'å¤šé ­' : 'ç©ºé ­';
            trendElement.textContent = trendText;
            trendElement.className = `trend-indicator ${trendClass}`;
            
            document.getElementById('trend-desc').textContent = data.trend.description;
            document.getElementById('trend-strength').textContent = `${(data.trend.strength * 100).toFixed(0)}%`;
            document.getElementById('consecutive-up').textContent = `${data.trend.consecutive_bars}æ ¹`;
            
            const returnValue = document.getElementById('avg-return');
            const avgReturn = data.trend.average_return * 100;
            returnValue.textContent = `${avgReturn > 0 ? '+' : ''}${avgReturn.toFixed(2)}%`;
            returnValue.className = avgReturn > 0 ? 'analysis-value positive' : 'analysis-value negative';

            // æœ€ä½³å…¥å ´é»
            document.getElementById('best-entry').textContent = `+${data.best_entry_bar}`;
            document.getElementById('lowest-price').textContent = `$${formatPrice(data.price_extremes.lowest_price)}`;
            document.getElementById('lowest-bar').textContent = `ç¬¬${data.price_extremes.lowest_bar}æ ¹Kæ£’å‡ºç¾`;
            document.getElementById('highest-price').textContent = `$${formatPrice(data.price_extremes.highest_price)}`;
            document.getElementById('highest-bar').textContent = `ç¬¬${data.price_extremes.highest_bar}æ ¹Kæ£’å‡ºç¾`;
            
            const profitValue = document.getElementById('potential-profit');
            const profit = data.price_extremes.potential_profit * 100;
            profitValue.textContent = `${profit > 0 ? '+' : ''}${profit.toFixed(2)}%`;
            profitValue.className = profit > 0 ? 'analysis-value positive' : 'analysis-value negative';

            // è©³ç´°å»ºè­°
            document.getElementById('analysis-recommendation').textContent = data.recommendation;

            // ç¹ªè£½é æ¸¬åœ–è¡¨
            drawAnalysisForecastChart(data);

            document.getElementById('analysis-results').style.display = 'block';
            showAnalysisAlert('success', 'âœ… å¸‚å ´åˆ†æå®Œæˆï¼');
        }

        // ç¹ªè£½åˆ†æé æ¸¬åœ–è¡¨
        function drawAnalysisForecastChart(data) {
            const chart = document.getElementById('analysis-forecast-chart');
            chart.innerHTML = '';
            
            const prices = data.forecast_prices;
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceSpan = maxPrice - minPrice || 1;
            const bestBar = data.best_entry_bar;
            const lowestBar = data.price_extremes.lowest_bar;
            const highestBar = data.price_extremes.highest_bar;

            prices.forEach((price, index) => {
                const height = ((price - minPrice) / priceSpan) * 200;
                const isPositive = index > 0 && price >= prices[index - 1];
                const barNum = index + 1;
                
                const item = document.createElement('div');
                item.className = 'kline-item';
                
                const bar = document.createElement('div');
                bar.className = `kline-bar ${isPositive ? 'positive' : 'negative'}`;
                bar.style.height = Math.max(20, height) + 'px';

                // æ¨™è¨˜æœ€ä½³å…¥å ´é»
                if (barNum === bestBar) {
                    bar.classList.add('best-entry');
                }

                const tooltip = document.createElement('div');
                tooltip.className = 'kline-tooltip';
                let tooltipText = `$${formatPrice(price)}`;
                if (barNum === bestBar) tooltipText += ' æœ€å„ªå…¥å ´';
                if (barNum === lowestBar) tooltipText += ' æœ€ä½é»';
                if (barNum === highestBar) tooltipText += ' æœ€é«˜é»';
                tooltip.textContent = tooltipText;
                bar.appendChild(tooltip);
                
                const label = document.createElement('div');
                label.className = 'kline-label';
                let labelText = `+${barNum}`;
                if (barNum === bestBar) labelText += ' â­';
                label.textContent = labelText;
                
                item.appendChild(bar);
                item.appendChild(label);
                chart.appendChild(item);
            });
        }

        // é¡¯ç¤ºçµæœ
        function displayResults(data) {
            document.getElementById('current-price').textContent = `$${formatPrice(data.current_price)}`;
            document.getElementById('predicted-price').textContent = `$${formatPrice(data.predicted_price)}`;
            
            const returnPercent = (data.log_return * 100).toFixed(2);
            const returnElement = document.getElementById('log-return');
            returnElement.textContent = `${returnPercent > 0 ? '+' : ''}${returnPercent}%`;
            returnElement.className = 'result-card-value ' + (returnPercent > 0 ? 'positive' : 'negative');
            
            document.getElementById('confidence').textContent = `${(data.confidence * 100).toFixed(2)}%`;
            
            const recElement = document.getElementById('recommendation');
            recElement.textContent = data.recommendation;
            recElement.className = 'recommendation ' + data.recommendation.toLowerCase();
            
            document.getElementById('entry-price').textContent = formatPrice(data.entry_price);
            document.getElementById('stop-loss').textContent = formatPrice(data.stop_loss);
            document.getElementById('take-profit').textContent = formatPrice(data.take_profit);
            
            document.getElementById('volatility-current').textContent = data.volatility.current.toFixed(4);
            document.getElementById('volatility-predicted').textContent = data.volatility.predicted.toFixed(4);
            document.getElementById('volatility-level').textContent = data.volatility.level;
            document.getElementById('atr-14').textContent = formatPrice(data.volatility.atr_14);
            
            document.getElementById('info-source').textContent = data.price_source;
            document.getElementById('info-model').textContent = data.model_version;
            document.getElementById('info-time').textContent = new Date(data.timestamp).toLocaleString('zh-TW');
            
            drawForecastChart(data.current_price, data.predicted_price, data.log_return);
            displayKlines(data.klines);
            
            document.getElementById('results').style.display = 'block';
            showAlert('success', 'âœ… é æ¸¬æˆåŠŸï¼');
        }

        // ç¹ªè£½æœªä¾†10æ ¹Kæ£’é æ¸¬
        function drawForecastChart(currentPrice, predictedPrice, logReturn) {
            const chart = document.getElementById('forecast-chart');
            chart.innerHTML = '';
            
            const priceRange = Math.abs(currentPrice * 0.05);
            const minPrice = Math.min(currentPrice, predictedPrice) - priceRange;
            const maxPrice = Math.max(currentPrice, predictedPrice) + priceRange;
            const priceSpan = maxPrice - minPrice;
            
            for (let i = 0; i < 10; i++) {
                const progress = (i + 1) / 10;
                const forecastPrice = currentPrice + (predictedPrice - currentPrice) * progress;
                const variance = (Math.random() - 0.5) * priceRange;
                const kPrice = forecastPrice + variance;
                
                const height = ((kPrice - minPrice) / priceSpan) * 200;
                const isPositive = kPrice >= currentPrice;
                
                const item = document.createElement('div');
                item.className = 'kline-item';
                
                const bar = document.createElement('div');
                bar.className = `kline-bar ${isPositive ? 'positive' : 'negative'}`;
                bar.style.height = Math.max(20, height) + 'px';
                
                const tooltip = document.createElement('div');
                tooltip.className = 'kline-tooltip';
                tooltip.textContent = `$${formatPrice(kPrice)}`;
                bar.appendChild(tooltip);
                
                const label = document.createElement('div');
                label.className = 'kline-label';
                label.textContent = `+${i + 1}`;
                
                item.appendChild(bar);
                item.appendChild(label);
                chart.appendChild(item);
            }
        }

        // é¡¯ç¤ºæœ€è¿‘Kç·š
        function displayKlines(klines) {
            const tbody = document.getElementById('klines-table');
            tbody.innerHTML = '';
            
            klines.forEach(k => {
                const row = document.createElement('tr');
                const time = new Date(k.timestamp).toLocaleString('zh-TW', { 
                    month: '2-digit', 
                    day: '2-digit', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                row.style.borderBottom = `1px solid var(--border-color)`;
                row.innerHTML = `
                    <td style="padding: 0.5rem;">${time}</td>
                    <td style="padding: 0.5rem; text-align: right;">${formatPrice(k.open)}</td>
                    <td style="padding: 0.5rem; text-align: right;">${formatPrice(k.high)}</td>
                    <td style="padding: 0.5rem; text-align: right;">${formatPrice(k.low)}</td>
                    <td style="padding: 0.5rem; text-align: right; color: ${k.close >= k.open ? 'var(--success-color)' : 'var(--error-color)'}; font-weight: bold;">${formatPrice(k.close)}</td>
                    <td style="padding: 0.5rem; text-align: right;">${(k.volume / 1e6).toFixed(2)}M</td>
                `;
                tbody.appendChild(row);
            });
        }

        // é¡¯ç¤ºæç¤º
        function showAlert(type, message) {
            const container = document.getElementById('alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // é¡¯ç¤ºåˆ†ææç¤º
        function showAnalysisAlert(type, message) {
            const container = document.getElementById('analysis-alert-container');
            container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // ä¿å­˜è¨­å®š
        function saveSettings() {
            const endpoint = document.getElementById('api-endpoint').value;
            localStorage.setItem('api_endpoint', endpoint);
            showAlert('success', 'âœ… è¨­å®šå·²ä¿å­˜');
            setTimeout(() => location.reload(), 1500);
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>
</html>