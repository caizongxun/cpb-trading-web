# 市場分析模組文檔

## 功能概述

市場分析模組可根據過去20根K棒的價格數據，分析未來10根K棒的趨勢，並自動找到最適合開單的點位。

### 核心邏輯

```
歷史數據 (20根K棒)
    ↓
  [分析趨勢]
    ↓
判斷: 多頭 或 空頭
    ↓
  [預測未來10根K棒]
    ↓
找出:
- 最低點位 (多頭時為最佳入場點)
- 最高點位 (空頭時為最佳入場點)  
- 相對極值
    ↓
  [生成交易建議]
    ↓
✓ 最優入場點位
✓ 止損價格
✓ 止盈目標
✓ 風險回報比
```

## API 端點

### POST /market-analysis

**請求參數:**

```json
{
  "symbol": "BTC",        // 幣種代碼
  "timeframe": "1d",      // 時間框架 ("1d" 或 "1h")
  "use_binance": false    // 是否使用 Binance API
}
```

**支援的幣種:**
- BTC, ETH, BNB, SOL, XRP, ADA, DOGE, AVAX, LTC, DOT, UNI, LINK, XLM, ATOM

**回應範例:**

```json
{
  "symbol": "BTC",
  "timeframe": "1d",
  "trend": {
    "direction": "uptrend",     // 多頭
    "strength": 0.78,            // 強度 (0-1)
    "consecutive_bars": 5,       // 連續上升根數
    "average_return": 1.23,      // 平均漲幅 (%)
    "description": "多頭上升趨勢明顯..."
  },
  "best_entry_bar": 3,          // 第3根K棒入場
  "price_extremes": {
    "lowest_price": 42150.00,    // 最低點
    "lowest_bar": 3,             // 最低點在第3根
    "highest_price": 44800.00,   // 最高點
    "highest_bar": 9,            // 最高點在第9根
    "potential_profit": 6.27     // 潛在收益 (%)
  },
  "forecast_prices": [42150, 42300, ..., 44800],  // 10根K棒預測價格
  "recommendation": "交易信號：強勢多頭..."
}
```

## 分析邏輯詳解

### 1. 趨勢判斷 (Trend Analysis)

#### 判斷方法

1. 取最近5根K棒作為分析樣本
2. 統計上升和下降根數
3. 計算上升比例: `上升根數 / 總根數`
4. 若上升比例 > 0.5 → 多頭；否則 → 空頭

#### 強度等級

```
if 比例 > 0.7:  強勢趨勢
if 比例 > 0.5:  中等趨勢  
if 比例 ≤ 0.5:  弱勢趨勢
```

#### 連續性分析

追蹤連續上升或下降的根數，越多越表示趨勢越強

### 2. 最佳入場點計算 (Optimal Entry Point)

#### 多頭策略 (Uptrend)

```
邏輯: 趨勢向上 → 在最低點入場 → 最小成本

最優入場點 = 未來10根中的最低價格所在的根數
止損 = 最低點 × 0.99
止盈 = 最高點
收益 = (最高點 - 入場點) / 入場點
```

**範例 (如圖所示):**

```
未來10根K棒走勢 (根據預測):
+1: $42,800
+2: $42,600  
+3: $42,150  ← 最低點 (最佳入場點 ⭐)
+4: $42,400
+5: $43,000
+6: $43,500  
+7: $43,800
+8: $44,200  
+9: $44,800  ← 最高點 (止盈目標)
+10: $44,500

收益: (44800 - 42150) / 42150 ≈ 6.27%
```

#### 空頭策略 (Downtrend)

```
邏輯: 趨勢向下 → 在最高點入場 → 最大利潤空間

最優入場點 = 未來10根中的最高價格所在的根數
止損 = 最高點 × 1.01
止盈 = 最低點
收益 = (入場點 - 最低點) / 入場點
```

### 3. 風險管理

#### 止損設定

- **多頭:** 在最低點下方0.5~1%
- **空頭:** 在最高點上方0.5~1%

#### 風險回報比 (Risk-Reward Ratio)

```
風險回報比 = 潛在收益 / 風險敞口

例如:
入場點: $42,150
止損: $42,150 × 0.99 = $41,729 (風險: $421)
止盈: $44,800 (收益: $2,650)

比例 = 2650 / 421 ≈ 6.3:1 (優秀)
```

## 前端使用指南

### 1. 打開分析頁面

在左側選單選擇「市場分析」

### 2. 設定參數

```
數據源: yfinance 或 Binance
幣種: 選擇要分析的幣種 (BTC, ETH, ...)
時間框架: 日線 (1D) 或 小時線 (1H)
```

### 3. 執行分析

點擊「執行分析」按鈕

### 4. 解讀結果

#### 趨勢判斷區

```
當前趨勢: [多頭/空頭]     ← 交易方向
趨勢強度: 75%             ← 可信度
連續上升根數: 5根          ← 趨勢持續度
平均漲幅: +2.35%          ← 每根K棒平均變化
```

#### K線圖 (最重要!)

```
綠色柱: 上升K棒
紅色柱: 下降K棒

⭐ 金星號: 最優入場點位
  (在未來第N根K棒進場)
```

#### 最佳開單點位

```
最優入場點: 第3根K棒   ← 何時進場
最低點位: $42,150      ← 預期最低點
最高點位: $44,800      ← 預期最高點
潛在收益: +5.4%        ← 預期利潤
```

## 實際交易指引

### 場景 1: 多頭趨勢 (Uptrend)

```
分析結果:
- 趨勢: 多頭 ✓
- 最佳入場: 第3根K棒 ($42,150)
- 止損: $41,729 (低於最低點)
- 止盈: $44,800 (最高點)

執行:
1. 在第3根K棒形成時設置買單 (Limit Order)
2. 止損掛在 $41,729
3. 止盈掛在 $44,800
4. 風險回報比 > 3:1 時才執行
```

### 場景 2: 空頭趨勢 (Downtrend)

```
分析結果:
- 趨勢: 空頭 ✗
- 最佳入場: 第7根K棒 ($43,800)
- 止損: $44,238 (高於最高點)
- 止盈: $41,500 (最低點)

執行:
1. 在第7根K棒形成時設置賣單 (Limit Order)
2. 止損掛在 $44,238
3. 止盈掛在 $41,500
4. 風險回報比 > 3:1 時才執行
```

## 局限性與風險提示

### ⚠️ 重要提醒

1. **預測非完全準確**
   - 未來價格預測基於歷史模式
   - 突發事件可能導致預測失效

2. **時間框架差異**
   - 日線分析不適用於分鐘線交易
   - 小時線結果可能在次日逆轉

3. **市場流動性**
   - 預測的最低/最高點可能無法成交
   - 使用限價單而非市場單

4. **風險管理**
   - 永遠使用止損
   - 不要超槓桿
   - 風險回報比 < 1:2 不建議交易

5. **多重確認**
   - 配合其他技術指標
   - 不要單獨依賴本工具
   - 關注基本面新聞

## 程式碼架構

### market_analysis.py

```python
class MarketAnalyzer:
    - analyze_trend()           # 分析趨勢方向和強度
    - find_price_extremes()     # 找最高最低點
    - calculate_best_entry()    # 計算最佳入場點
    - generate_recommendation() # 生成交易建議
    - analyze()                 # 執行完整分析
```

### app.py

```python
@app.post("/market-analysis")
    ↓
DataFetcher.fetch_klines()  # 獲取歷史數據
    ↓
MarketAnalyzer.analyze()    # 執行分析
    ↓
返回結果給前端
```

### index.html

```
頁面: 「市場分析」標籤
    ↓
調用 /market-analysis API
    ↓
繪製K線圖 + 標記最佳入場點
    ↓
顯示詳細交易建議
```

## 快速入門

### 1. 安裝依賴

```bash
pip install numpy pydantic fastapi uvicorn
```

### 2. 啟動 API

```bash
python app.py
```

### 3. 訪問前端

```
http://localhost:8000
```

### 4. 測試分析

```bash
curl -X POST http://localhost:8001/market-analysis \
  -H "Content-Type: application/json" \
  -d '{
    "symbol": "BTC",
    "timeframe": "1d",
    "use_binance": false
  }'
```

## 常見問題

### Q: 為什麼某些幣種沒有數據?

A: 確認該幣種是否支援。使用 `/coins` 端點查看完整列表。

### Q: 準確度有多高?

A: 短期內 (1-3根K棒) 準確度約 65-70%。長期預測準確度會降低。

### Q: 可以用於期貨交易嗎?

A: 可以。但建議降低槓桿，使用更寬鬆的止損。

### Q: 如何整合到自動交易機器人?

A: 調用 `/market-analysis` API，根據返回的 `best_entry_bar` 和 `recommendation` 執行交易。

## 更新日誌

### v1.0 (2025-12-25)

- 初版發佈
- 實現趨勢分析
- 實現最佳入場點計算
- 實現前端視覺化
- 支援 14 種加密貨幣
